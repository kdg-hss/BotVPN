#!/bin/bash
set -e

# Colors
green="\e[38;5;82m"
red="\e[38;5;196m"
neutral="\e[0m"

# Install Node.js if needed
if ! command -v node >/dev/null 2>&1; then
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    apt-get install -y nodejs build-essential
fi

# Clone repo if not exists
if [ ! -d "/root/BotVPN" ]; then
    git clone https://github.com/kdg-hss/BotVPN.git /root/BotVPN
fi

# Install npm dependencies
npm install --prefix /root/BotVPN express telegraf axios sqlite3 dotenv

# Create .vars.json
read -p "Masukkan BOT_TOKEN: " BOT_TOKEN
read -p "Masukkan USER_ID: " USER_ID
read -p "Masukkan PAYDISINI_KEY: " PAYDISINI_KEY
read -p "Masukkan NAMA_STORE: " NAMA_STORE

cat > /root/BotVPN/.vars.json <<EOF
{
  "BOT_TOKEN": "$BOT_TOKEN",
  "USER_ID": "$USER_ID",
  "PAYDISINI_KEY": "$PAYDISINI_KEY",
  "NAMA_STORE": "$NAMA_STORE",
  "PORT": "50123"
}
EOF

# Create systemd service
cat >/etc/systemd/system/sellvpn.service <<EOF
[Unit]
Description=App Bot sellvpn Service
After=network.target

[Service]
ExecStart=/usr/bin/node /root/BotVPN/app.js
Restart=always
User=root
Environment=PATH=/usr/bin:/usr/local/bin
Environment=NODE_ENV=production
WorkingDirectory=/root/BotVPN

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable sellvpn.service
systemctl restart sellvpn.service

echo -e "${green}âœ…  Install selesai, bot sudah berjalan.${neutral}"
